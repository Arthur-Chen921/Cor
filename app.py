# app.py
import streamlit as st
import pandas as pd
import plotly.express as px

# æ¨¡æ‹Ÿæ•°æ®åº“
supplier_db = {
    "suppliers": [
        {"id": "RF-202403", "name": "é”é”‹ç²¾å¯†", "category": "ç”µæ± æ‰˜ç›˜", 
         "qualification": "Açº§", "price": 15800, "delivery_score": 92}
    ],
    "conflicts": [
        {"event_id": "C-001", "supplier_id": "RF-202403", 
         "conflict_type": "ä¸‰é‡å†²çª", "status": "å·²è§£å†³"}
    ],
    "arbitrations": [
        {"event_id": "C-001", "resolution": "æœ‰æ¡ä»¶é€šè¿‡", 
         "conditions": ["è¯•ç”¨æœŸ3ä¸ªæœˆ", "é¦–ä»˜30%", "è¡¥å……å°½è°ƒ"]}
    ]
}

# é¡µé¢é…ç½®
st.set_page_config(page_title="é“¾æ™ºå®¡ç³»ç»Ÿæ¼”ç¤º", layout="wide")

# æ ‡é¢˜åŒº
st.title("ğŸ› ï¸ ä¾›åº”é“¾AIååŒå®¡æ ¸ç³»ç»Ÿ - é“¾æ™ºå®¡")
st.markdown("---")

# åŠŸèƒ½æ¨¡å—
with st.sidebar:
    st.header("å¯¼èˆª")
    page = st.radio("é€‰æ‹©æ¼”ç¤ºæ¨¡å—", ["å†²çªåœºæ™¯æ¨¡æ‹Ÿ", "ä»²è£å·¥ä½œæµ", "å®æ–½æ¡ˆä¾‹åº“"])
    
    # å‚æ•°è°ƒèŠ‚
    st.header("å‚æ•°è°ƒèŠ‚")
    base_price = st.slider("è®¾å®šåŸºå‡†ä»·æ ¼ï¼ˆä¸‡å…ƒï¼‰", 10.0, 20.0, 14.2)
    risk_threshold = st.slider("é£é™©é˜ˆå€¼ï¼ˆ0-100ï¼‰", 0, 100, 60)

# åœºæ™¯æ¨¡æ‹Ÿé¡µ
if page == "å†²çªåœºæ™¯æ¨¡æ‹Ÿ":
    st.header("ğŸ” ä¾›åº”å•†èµ„è´¨å®¡æ ¸å†²çªæ¨¡æ‹Ÿ")
    
    current_price = supplier_db["suppliers"][0]["price"] / 10000
    price_deviation = (current_price - base_price) / base_price * 100
    
    col1, col2, col3 = st.columns(3)
    with col1:
        st.subheader("é‡‡è´­éƒ¨é—¨AI")
        st.metric("äº¤ä»˜èƒ½åŠ›è¯„åˆ†", "92/100", delta="æ¨èç­‰çº§A")
        st.progress(0.92)
        with st.expander("AIå†³ç­–é€»è¾‘è¯¦æƒ…"):
            st.markdown("**æ¨¡å‹æ¶æ„**")
            st.code("""- ç±»å‹ï¼šéšæœºæ£®æ—
- è¾“å…¥ç‰¹å¾ï¼š
  âœ“ å†å²äº¤ä»˜å‡†æ—¶ç‡(30%)
  âœ“ èµ„è´¨è¯ä¹¦å®Œæ•´æ€§(25%)
  âœ“ äº§èƒ½ç¨³å®šæ€§(25%)
  âœ“ åˆä½œå¹´é™(20%)""")
            st.markdown("**æ•°æ®æº**")
            st.write("ERPç³»ç»Ÿ + ä¾›åº”å•†è‡ªå¡«è¡¨å•")
        
    with col2:
        st.subheader("æ³•åŠ¡éƒ¨é—¨AI")
        risk_level = "é«˜" if risk_threshold < 70 else "ä¸­"
        st.metric("é£é™©è¯„çº§", risk_level, delta="1æ¡å…³è”è¯‰è®¼", delta_color="inverse")
        with st.expander("AIå†³ç­–é€»è¾‘è¯¦æƒ…"):
            st.markdown("**æ¨¡å‹æ¶æ„**")
            st.code("""- ç±»å‹ï¼šå›¾ç¥ç»ç½‘ç»œ
- åˆ†æç»´åº¦ï¼š
  âœ“ ç›´æ¥æ³•å¾‹é£é™©(40%)
  âœ“ å…³è”æ–¹é£é™©(30%)
  âœ“ è¡Œä¸šåˆè§„è¶‹åŠ¿(20%)
  âœ“ èˆ†æƒ…é£é™©(10%)""")
            st.markdown("**æ•°æ®æº**")
            st.write("è£åˆ¤æ–‡ä¹¦ç½‘ + ä¼ä¸šå…³ç³»å›¾è°±")
        
    with col3:
        st.subheader("è´¢åŠ¡éƒ¨é—¨AI")
        st.metric("ä»·æ ¼åç¦»åº¦", f"{price_deviation:.1f}%", 
                 delta="è¶…å‡ºé˜ˆå€¼" if abs(price_deviation)>5 else "åœ¨å…è®¸èŒƒå›´å†…", 
                 delta_color="inverse" if abs(price_deviation)>5 else "normal")
        with st.expander("AIå†³ç­–é€»è¾‘è¯¦æƒ…"):
            st.markdown("**æ¨¡å‹æ¶æ„**")
            st.code("""- ç±»å‹ï¼šLSTMæ—¶åºé¢„æµ‹
- è€ƒè™‘å› ç´ ï¼š
  âœ“ å†å²é‡‡è´­ä»·æ ¼(50%)
  âœ“ åŸææ–™ä»·æ ¼æŒ‡æ•°(30%)
  âœ“ æ±‡ç‡æ³¢åŠ¨(15%)
  âœ“ è¿è¾“æˆæœ¬(5%)""")
            st.markdown("**æ•°æ®æº**")
            st.write("è´¢åŠ¡ç³»ç»Ÿ + å¤§å®—å•†å“äº¤æ˜“å¹³å°")
    
    st.markdown("---")
    st.subheader("è·¨AIç³»ç»Ÿè¾“å‡ºå¯¹æ¯”")
    
    # æ–°å¢AIè¾“å‡ºå¯¹æ¯”é›·è¾¾å›¾
    radar_df = pd.DataFrame(dict(
        æŒ‡æ ‡=["äº¤ä»˜èƒ½åŠ›", "é£é™©æ§åˆ¶", "æˆæœ¬æ•ˆç›Š", "åˆè§„æ€§", "å¯æŒç»­æ€§"],
        é‡‡è´­AI=[92, 60, 85, 70, 65],
        æ³•åŠ¡AI=[75, 35, 60, 30, 55],
        è´¢åŠ¡AI=[80, 70, 68, 75, 60]
    ))
    
    fig = px.line_polar(radar_df, r='é‡‡è´­AI', theta='æŒ‡æ ‡', line_close=True,
                        title="éƒ¨é—¨AIè¯„ä¼°ç»´åº¦å¯¹æ¯”")
    fig.add_scatterpolar(r=radar_df['æ³•åŠ¡AI'], theta=radar_df['æŒ‡æ ‡'], name='æ³•åŠ¡AI')
    fig.add_scatterpolar(r=radar_df['è´¢åŠ¡AI'], theta=radar_df['æŒ‡æ ‡'], name='è´¢åŠ¡AI')
    st.plotly_chart(fig, use_container_width=True)

# å·¥ä½œæµé¡µ
elif page == "ä»²è£å·¥ä½œæµ":
    st.header("âš™ï¸ ä¸‰é˜¶æ²»ç†å·¥ä½œæµæ¼”ç¤º")
    
    tab1, tab2, tab3, tab4 = st.tabs(["å†²çªè¯†åˆ«", "ä»²è£ä¼šè®®", "ç³»ç»Ÿè¿æº", "æ‰§è¡Œè·Ÿè¸ª"])
    
    # å†²çªè¯†åˆ«æ ‡ç­¾é¡µ
    with tab1:
        st.subheader("é˜¶æ®µ1ï¼šå¤šAIè¾“å‡ºåˆ†æ")
        
        col1, col2 = st.columns([2,1])
        with col1:
            st.markdown("**å†²çªç‰¹å¾æå–**")
            st.code("""è¯†åˆ«åˆ°çš„AIè¾“å‡ºå·®å¼‚ï¼š
1. é‡‡è´­AIç½®ä¿¡åº¦ï¼š92% (é«˜ç½®ä¿¡æ¨è)
2. æ³•åŠ¡AIç½®ä¿¡åº¦ï¼š78% (ä¸­ç­‰é£é™©)
3. è´¢åŠ¡AIç½®ä¿¡åº¦ï¼š85% (é«˜ç¡®å®šæ€§è¶…æ ‡)""")
            
            st.markdown("**å·®å¼‚ç±»å‹åˆ¤å®š**")
            st.write("""
            - ç›®æ ‡å†²çªï¼šæ•ˆç‡vsåˆè§„vsæˆæœ¬
            - æ•°æ®æºå·®å¼‚ï¼šè¿è¥æ•°æ®vsæ³•å¾‹æ•°æ®vsè´¢åŠ¡æ•°æ®
            - æ¨¡å‹å·®å¼‚ï¼šç›‘ç£å­¦ä¹ vså›¾è®¡ç®—vsæ—¶åºåˆ†æ""")
            
        with col2:
            st.markdown("**å†²çªåˆ†ç±»çŸ©é˜µ**")
            matrix_df = pd.DataFrame([
                ["å•ä¸€æŒ‡æ ‡è¶…æ ‡", "è‡ªåŠ¨è¡¥å¿è°ˆåˆ¤", "2å°æ—¶"],
                ["åŒé‡ç›®æ ‡å†²çª", "éƒ¨é—¨è”å¸­é¢„å®¡", "8å°æ—¶"],
                ["ä¸‰é‡å†²çª+ç½®ä¿¡å·®å¼‚", "AIä»²è£å§”å‘˜ä¼š", "24å°æ—¶"]
            ], columns=["å†²çªç±»å‹", "å¤„ç†é€šé“", "æ—¶é™"])
            st.dataframe(matrix_df, use_container_width=True)
        
        st.markdown("---")
        st.subheader("AIè¾“å‡ºæº¯æºéªŒè¯")
        
        verify_df = pd.DataFrame([
            ["é‡‡è´­AI", "äº¤ä»˜å‡†æ—¶ç‡", "98%", "ERPè®¢å•æ•°æ®", "å·²éªŒè¯"],
            ["æ³•åŠ¡AI", "å…³è”è¯‰è®¼", "1æ¡", "è£åˆ¤æ–‡ä¹¦ç½‘", "å·²æ ¸å®"],
            ["è´¢åŠ¡AI", "ä»·æ ¼åç¦»åº¦", "+12%", "å†å²é‡‡è´­è®°å½•", "éœ€å¤æ ¸"]
        ], columns=["AIç³»ç»Ÿ", "å…³é”®æŒ‡æ ‡", "è¾“å‡ºå€¼", "æ•°æ®æº", "éªŒè¯çŠ¶æ€"])
        
        st.dataframe(verify_df.style.applymap(
            lambda x: "color: green" if x=="å·²éªŒè¯" else "color: orange" if x=="å·²æ ¸å®" else "color: red"), 
            use_container_width=True)
    
    # ä»²è£ä¼šè®®æ ‡ç­¾é¡µ
    with tab2:
        st.subheader("ä»²è£ä¼šè®®è¿›ç¨‹")
        
        timeline_df = pd.DataFrame([
            {"é˜¶æ®µ": "ä¼šå‰å‡†å¤‡", "çŠ¶æ€": "å·²å®Œæˆ", "è€—æ—¶": 2, "è´Ÿè´£äºº": "ç³»ç»Ÿè‡ªåŠ¨"},
            {"é˜¶æ®µ": "è¯æ®è°ƒå–", "çŠ¶æ€": "è¿›è¡Œä¸­", "è€—æ—¶": 1, "è´Ÿè´£äºº": "å†…å®¡éƒ¨"},
            {"é˜¶æ®µ": "å¤šæ–¹å¬è¯", "çŠ¶æ€": "å¾…å¤„ç†", "è€—æ—¶": 3, "è´Ÿè´£äºº": "ä»²è£ä¸»å¸­"},
            {"é˜¶æ®µ": "å†³è®®ç”Ÿæˆ", "çŠ¶æ€": "å¾…å¤„ç†", "è€—æ—¶": 1, "è´Ÿè´£äºº": "AIé¡¾é—®"}
        ])
        
        col1, col2 = st.columns([3,1])
        with col1:
            st.markdown("**å¤šAIè¯æ®é“¾åˆ†æ**")
            st.code("""é‡‡è´­AIè¯æ®é“¾ï¼š
âœ“ 10æ¬¡å‡†æ—¶äº¤ä»˜è®°å½•
âœ“ 3é¡¹è´¨é‡è®¤è¯è¯ä¹¦
âœ“ äº§èƒ½åˆ©ç”¨ç‡85%

æ³•åŠ¡AIé£é™©é“¾ï¼š
âœ— å…³è”ä¼ä¸šæœªå†³è¯‰è®¼
âœ— åˆåŒæ¨¡ç‰ˆç‰ˆæœ¬è¿‡æœŸ
âœ“ æ— è¡Œæ”¿å¤„ç½šè®°å½•

è´¢åŠ¡AIæˆæœ¬é“¾ï¼š
âœ“ æŠ¥ä»·é«˜äºè¡Œä¸šåŸºå‡†
âœ“ ä»˜æ¬¾æ¡æ¬¾é£é™©ä¸­ç­‰
âœ“ æ±‡ç‡é£é™©å¯æ§""")
            
        with col2:
            st.markdown("**AIç½®ä¿¡åº¦è¯„ä¼°**")
            st.metric("é‡‡è´­AIç½®ä¿¡åº¦", "92%", delta="é«˜å¯ä¿¡åŒºé—´")
            st.metric("æ³•åŠ¡AIç½®ä¿¡åº¦", "78%", delta_color="inverse")
            st.metric("è´¢åŠ¡AIç½®ä¿¡åº¦", "85%", delta="é«˜å¯ä¿¡åŒºé—´")
    
    # ç³»ç»Ÿè¿æºæ ‡ç­¾é¡µ
    with tab3:
        st.subheader("ç³»ç»Ÿè¿æºæ‹“æ‰‘")
        
        nodes = pd.DataFrame([
            {"èŠ‚ç‚¹": "é“¾æ™ºå®¡æ ¸å¿ƒ", "ç±»å‹": "ä¸­æ¢ç³»ç»Ÿ", "x": 2, "y": 2},
            {"èŠ‚ç‚¹": "ERP", "ç±»å‹": "ä¸šåŠ¡ç³»ç»Ÿ", "x": 1, "y": 1},
            {"èŠ‚ç‚¹": "åˆåŒæ•°æ®åº“", "ç±»å‹": "æ³•åŠ¡ç³»ç»Ÿ", "x": 3, "y": 1},
            {"èŠ‚ç‚¹": "è´¢åŠ¡ä¸­å°", "ç±»å‹": "è´¢åŠ¡ç³»ç»Ÿ", "x": 2, "y": 0},
            {"èŠ‚ç‚¹": "èˆ†æƒ…ç›‘æ§", "ç±»å‹": "å¤–éƒ¨æ•°æ®", "x": 4, "y": 2}
        ])
        
        edges = [
            {"æ¥æº": "é“¾æ™ºå®¡æ ¸å¿ƒ", "ç›®æ ‡": "ERP", "ç±»å‹": "å®æ—¶æ•°æ®"},
            {"æ¥æº": "é“¾æ™ºå®¡æ ¸å¿ƒ", "ç›®æ ‡": "åˆåŒæ•°æ®åº“", "ç±»å‹": "APIè°ƒç”¨"},
            {"æ¥æº": "é“¾æ™ºå®¡æ ¸å¿ƒ", "ç›®æ ‡": "è´¢åŠ¡ä¸­å°", "ç±»å‹": "åŒå‘åŒæ­¥"},
            {"æ¥æº": "é“¾æ™ºå®¡æ ¸å¿ƒ", "ç›®æ ‡": "èˆ†æƒ…ç›‘æ§", "ç±»å‹": "æ•°æ®æŠ“å–"}
        ]
        
        fig = px.scatter(nodes, x="x", y="y",
                        size=[30,20,20,20,20],
                        color="ç±»å‹",
                        text="èŠ‚ç‚¹",
                        title="ç³»ç»Ÿé›†æˆæ‹“æ‰‘å›¾")
        
        for edge in edges:
            source = nodes[nodes["èŠ‚ç‚¹"] == edge["æ¥æº"]].iloc[0]
            target = nodes[nodes["èŠ‚ç‚¹"] == edge["ç›®æ ‡"]].iloc[0]
            fig.add_shape(
                type="line",
                x0=source["x"], y0=source["y"],
                x1=target["x"], y1=target["y"],
                line=dict(color="#BDBDBD", width=2)
            )
            
        fig.update_traces(marker=dict(size=100),
                         textfont=dict(size=14))
        st.plotly_chart(fig, use_container_width=True)
        
        st.markdown("**å®æ—¶æ•°æ®æµçŠ¶æ€**")
        flow_df = pd.DataFrame([
            ["ERPâ†’æ ¸å¿ƒ", "é‡‡è´­è®¢å•", "æ­£å¸¸", "5ms"],
            ["æ³•åŠ¡â†’æ ¸å¿ƒ", "åˆåŒæ¡æ¬¾", "å»¶è¿Ÿ", "320ms"],
            ["è´¢åŠ¡â†’æ ¸å¿ƒ", "æˆæœ¬æ•°æ®", "æ­£å¸¸", "8ms"],
            ["èˆ†æƒ…â†’æ ¸å¿ƒ", "è¡Œä¸šé£é™©", "æ­£å¸¸", "120ms"]
        ], columns=["é€šé“", "æ•°æ®ç±»å‹", "çŠ¶æ€", "å»¶è¿Ÿ"])
        st.dataframe(flow_df.style.applymap(
            lambda x: "color: red" if x=="å»¶è¿Ÿ" else None), 
            use_container_width=True)
    
    # æ‰§è¡Œè·Ÿè¸ªæ ‡ç­¾é¡µ
    with tab4:
        st.subheader("æ‰§è¡Œè¿½è¸ªçŸ©é˜µ")
        task_df = pd.DataFrame([
            ["åˆåŒä¿®è®¢", "æ³•åŠ¡éƒ¨", "å†…å®¡éƒ¨", "é£é™©<30"],
            ["ä»˜æ¬¾è°ƒæ•´", "è´¢åŠ¡éƒ¨", "ä¾›åº”é“¾éƒ¨", "åå·®<5%"],
            ["å…³ç³»ç»´æŠ¤", "é‡‡è´­éƒ¨", "å®¢æˆ·æˆåŠŸéƒ¨", "è¯„åˆ†â‰¥4"]
        ], columns=["ä»»åŠ¡", "æ‰§è¡Œæ–¹", "ç›‘ç£æ–¹", "éªŒæ”¶æ ‡å‡†"])
        
        st.dataframe(task_df.style.applymap(
            lambda x: "background-color: #e6f3ff" if x=="æ³•åŠ¡éƒ¨" else ""), 
            use_container_width=True)
        
        st.button("æ¨¡æ‹Ÿå®Œæˆé€šçŸ¥", help="ç‚¹å‡»å‘é€å®Œæˆé€šçŸ¥é‚®ä»¶")

# å®æ–½æ¡ˆä¾‹åº“é¡µ
elif page == "å®æ–½æ¡ˆä¾‹åº“":
    st.header("ğŸ“š å®æ–½æ¡ˆä¾‹åº“")
    
    case_filter = st.selectbox("ç­›é€‰æ¡ˆä¾‹ç±»å‹", ["å…¨éƒ¨", "ä¸‰é‡å†²çª", "åŒé‡å†²çª", "å•ä¸€å†²çª"])
    
    case_df = pd.DataFrame({
        "æ¡ˆä¾‹ID": ["C-2023-045", "C-2024-012", "C-2024-018"],
        "å†²çªç±»å‹": ["ä¸‰é‡å†²çª", "åŒé‡å†²çª", "å•ä¸€å†²çª"],
        "å¤„ç½®æ–¹å¼": ["æœ‰æ¡ä»¶é€šè¿‡", "è°ƒæ•´åé€šè¿‡", "è‡ªåŠ¨å¤„ç†"],
        "å¤„ç†æ—¶é•¿": [24, 8, 2],
        "ä¿ç•™ç»“æœ": ["æˆåŠŸåˆä½œ", "è¿›è¡Œä¸­", "å·²ç»ˆæ­¢"]
    })
    
    if case_filter != "å…¨éƒ¨":
        case_df = case_df[case_df["å†²çªç±»å‹"] == case_filter]
    
    st.dataframe(case_df, use_container_width=True)
    
    with st.expander("æ¡ˆä¾‹è¶‹åŠ¿åˆ†æ"):
        fig = px.line(case_df, x="æ¡ˆä¾‹ID", y="å¤„ç†æ—¶é•¿",
                     title="æ¡ˆä¾‹å¤„ç†æ•ˆç‡è¶‹åŠ¿")
        st.plotly_chart(fig, use_container_width=True)

st.markdown("---")
st.caption("æ¼”ç¤ºç³»ç»Ÿè¯´æ˜ï¼šæœ¬ç³»ç»Ÿä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å±•ç¤ºæ ¸å¿ƒä¸šåŠ¡æµç¨‹")
